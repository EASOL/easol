sudo: required
dist: trusty

# see http://about.travis-ci.org/docs/user/languages/php/ for more hints
language: php

# list any PHP version you want to test against
php:
  # using major version aliases
  - 7.0

# optionally specify a list of environments, for example to test different RDBMS
#env:
#  - DB=mysql
#  - DB=pgsql


before_script:
  - cd travis
  - sudo bash Ubuntu-14-04-MSFT-ODBC-Driver.sh 
  - cd ..

  # Pear, Pecl, sqlsrv install
  - sudo yes "" | sudo add-apt-repository ppa:ondrej/php
  - sudo apt-get update
  - sudo apt-get install php7.0
  - sudo apt-get install php-pear php7.0-dev
  - pear version
  - pecl version
  - sudo pecl search sqlsr
  - sudo pecl install sqlsrv-4.0.5
  - sudo pecl install pdo_sqlsrv-4.0.5
  

 
  #And finally, add the extension to php.ini. In Travis, do:
  - echo 'extension = sqlsrv.so' >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini
  #- echo "extension = sqlsrv.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini

  - mv application/config/database.ci.php application/config/database.php
  - cp tests/functional.suite.template.yml tests/functional.suite.yml
  - sed 's/{{test-key}}/'"$CI_TEST_KEY"'/' -i tests/functional.suite.yml
  - sudo chmod ug+x vendor/codeception/codeception/codecept
  - sudo chmod ug+x vendor/bin/codecept
  - php -S localhost:8000 > /dev/null &
  - vendor/bin/codecept build
  
script:
  - vendor/bin/codecept run functional

after_script:
  - sqlcmd -S $CI_DATABASE_HOSTNAME -d $CI_DATABASE_NAME -U $CI_DATABASE_USERNAME -P $CI_DATABASE_PASSWORD -I
  - php test.php

# configure notifications (email, IRC, campfire etc)
#notifications:
#  irc: "irc.freenode.org#travis"
